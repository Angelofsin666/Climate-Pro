blueprint:
  name: "‚ùÑÔ∏è Clima Automatico ‚Äì Risparmio Energetico | Energy-saving Climate"
  description: >
    üáÆüáπ Questo blueprint automatizza il climatizzatore in base alla temperatura media di uno o pi√π sensori,  
    alla presenza in casa, allo stato delle finestre e alla fascia oraria configurata.  
    Permette di risparmiare energia alternando la modalit√† climatizzazione e deumidificazione:  
    - Se la temperatura supera la soglia alta configurata, attiva la climatizzazione (o ritorna ad essa se si era in deumidificazione).  
    - Se la temperatura scende sotto la soglia bassa configurata, attiva la modalit√† deumidificazione.  
    L'automazione funziona solo se almeno una persona √® in casa e tutte le finestre sono chiuse.  
    Supporta notifiche opzionali e pi√π sensori di temperatura (con media).  

    üá¨üáß This blueprint automates the AC based on the average temperature from one or more sensors,  
    presence at home, window status, and configured time range.  
    It saves energy by switching between climate and dehumidify modes:  
    - If temperature rises above the high threshold, it activates climate mode (or returns to it from dehumidify).  
    - If temperature falls below the low threshold, it activates dehumidify mode.  
    The automation runs only if someone is home and all windows are closed.  
    Supports optional notifications and multiple temperature sensors (averaged).  

  domain: automation

  input:
    temp_sensors:
      name: ‚ùÑÔ∏è Sensori di temperatura | Temperature sensors
      description: >
        üáÆüáπ Seleziona uno o pi√π sensori di temperatura (viene usata la media).
        üá¨üáß Select one or more temperature sensors (average is used).
      selector:
        entity:
          multiple: true
          filter:
            domain: sensor
          device_class: temperature

    presence_entities:
      name: üßç‚Äç‚ôÇÔ∏è Persone presenti | Presence entities
      description: >
        üáÆüáπ L'automazione funziona solo se almeno una di queste entit√† √® "home".
        üá¨üáß Automation only runs if at least one of these is "home".
      selector:
        entity:
          multiple: true
          filter:
            domain: person

    windows:
      name: ü™ü Finestre da monitorare | Windows to monitor
      description: >
        üáÆüáπ Tutte queste finestre devono essere chiuse (off).
        üá¨üáß All selected windows must be closed (off).
      selector:
        entity:
          multiple: true
          filter:
            domain: binary_sensor
            device_class: window

    time_start:
      name: ‚è∞ Ora inizio | Start time
      default: "08:00:00"
      selector:
        time:

    time_end:
      name: ‚è∞ Ora fine | End time
      default: "22:30:00"
      selector:
        time:

    temp_high:
      name: üî• Temperatura alta | High temperature threshold
      default: 27
      selector:
        number:
          min: 20
          max: 30
          unit_of_measurement: ¬∞C
          mode: slider

    temp_low:
      name: ‚ùÑÔ∏è Temperatura bassa | Low temperature threshold
      default: 25.5
      selector:
        number:
          min: 18
          max: 27
          unit_of_measurement: ¬∞C
          mode: slider

    climate_script:
      name: üåÄ Script climatizzazione | AC script
      description: Script da avviare per la modalit√† climatizzazione
      selector:
        entity:
          filter:
            domain: script

    dehumid_script:
      name: üíß Script deumidificatore | Dehumidifier script
      description: Script da avviare per la modalit√† deumidificatore
      selector:
        entity:
          filter:
            domain: script

    return_to_climate_script:
      name: üîÑ Script ritorno climatizzazione | Return to climate script
      description: Script che riporta il clima da deumidificazione a climatizzazione
      selector:
        entity:
          filter:
            domain: script

    clima_on_boolean:
      name: ‚úÖ Boolean clima attivo | AC on boolean
      selector:
        entity:
          filter:
            domain: input_boolean

    dehumid_on_boolean:
      name: ‚úÖ Boolean deumidificatore attivo | Dehumidifier on boolean
      selector:
        entity:
          filter:
            domain: input_boolean

    notify_device:
      name: üì± Dispositivo per notifiche (opzionale) | Notification device (optional)
      default: []
      selector:
        device:
          multiple: false
          filter:
            integration: mobile_app

mode: single

trigger:
  - platform: numeric_state
    entity_id: !input temp_sensors
    above: !input temp_high
    id: caldo
  - platform: numeric_state
    entity_id: !input temp_sensors
    below: !input temp_low
    id: fresco
  - platform: state
    entity_id: !input temp_sensors
    id: cambio_temp

condition:
  - condition: time
    after: !input time_start
    before: !input time_end
  - condition: or
    conditions:
      - condition: state
        entity_id: !input presence_entities
        state: "home"
  - condition: and
    conditions:
      - condition: state
        entity_id: !input windows
        state: "off"

action:
  - choose:
      - conditions:
          - condition: or
            conditions:
              - condition: trigger
                id: caldo
              - condition: and
                conditions:
                  - condition: trigger
                    id: cambio_temp
                  - condition: numeric_state
                    entity_id: !input temp_sensors
                    above: !input temp_high
        sequence:
          - choose:
              - conditions:
                  - condition: state
                    entity_id: !input clima_on_boolean
                    state: "off"
                sequence:
                  - service: script.turn_on
                    target:
                      entity_id: !input climate_script
                  - service: input_boolean.turn_on
                    target:
                      entity_id: !input clima_on_boolean
                  - service: input_boolean.turn_off
                    target:
                      entity_id: !input dehumid_on_boolean

              - conditions:
                  - condition: state
                    entity_id: !input dehumid_on_boolean
                    state: "on"
                sequence:
                  - service: script.turn_on
                    target:
                      entity_id: !input return_to_climate_script
                  - service: input_boolean.turn_on
                    target:
                      entity_id: !input clima_on_boolean
                  - service: input_boolean.turn_off
                    target:
                      entity_id: !input dehumid_on_boolean

          - choose:
              - conditions:
                  - condition: device
                    device_id: !input notify_device
                sequence:
                  - service: notify.mobile_app_{{ device_attr(notify_device, 'name') | lower | replace(' ', '_') }}
                    data:
                      message: "‚ùÑÔ∏è Climatizzatore attivato (modalit√† climatizzazione)"
                      title: "Clima automatico"

      - conditions:
          - condition: or
            conditions:
              - condition: trigger
                id: fresco
              - condition: and
                conditions:
                  - condition: trigger
                    id: cambio_temp
                  - condition: numeric_state
                    entity_id: !input temp_sensors
                    below: !input temp_low
        sequence:
          - service: script.turn_on
            target:
              entity_id: !input dehumid_script
          - service: input_boolean.turn_on
            target:
              entity_id: !input dehumid_on_boolean
          - service: input_boolean.turn_off
            target:
              entity_id: !input clima_on_boolean

          - choose:
              - conditions:
                  - condition: device
                    device_id: !input notify_device
                sequence:
                  - service: notify.mobile_app_{{ device_attr(notify_device, 'name') | lower | replace(' ', '_') }}
                    data:
                      message: "üíß Deumidificatore attivato"
                      title: "Clima automatico"
